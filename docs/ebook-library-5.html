<!doctype html>
<html lang="en">
    <head>
    

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166292985-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166292985-1');
    </script>
    

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet" crossorigin="anonymous">
    
    <link rel="stylesheet" href="/theme/pygment-github.css">
    <link rel="stylesheet" href="/theme/article.css"> 

    <title>Building my own ebook library (#5)</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/images/favicon/site.webmanifest">
    <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
<!-- Mathjax -->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_SVG">
  MathJax.Hub.Config({
    tex2jax: {
    	inlineMath: [ ['$','$'] ],
    	processEscapes: true
    },
	"HTML-CSS": {
		fonts: ["TeX"] 
	}
  });
</script>

    </head>

    <body>
    
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: rgb(78, 76, 103);">
        <a class="navbar-brand" href="//julienharbulot.com/index.html"><img src="//julienharbulot.com/images/logo.svg" width="30" alt=""></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
                    <a class="nav-link" href="//julienharbulot.com/technical-blog.html">Technical blog</a>
            </li>
            
            <li class="nav-item">
                    <a class="nav-link" href="//julienharbulot.com/maths.html">Maths</a>
            </li>
            
            <li class="nav-item">
                    <a class="nav-link" href="//julienharbulot.com/research.html">Research</a>
            </li>
            
            <li class="nav-item">
                    <a class="nav-link" href="//julienharbulot.com/projects.html">Projects</a>
            </li>
            
            <!--<li class="nav-item">
                <a class="nav-link" href="//julienharbulot.com/about-me.html">About me</a>
            </li>-->
            


            </ul>
        </div>
    </nav>
    
    
    
    <div class="container">
    <div class="row mt-5">
      <div class="col-lg-8 mx-auto"> 
        <h1 class="display-5">Building my own ebook library (#5) </h1>
        <div class="text-right">16 Jun 2018</div>
      </div>
    </div>
    <div class="row mt-5">
    <article class="col-lg-8 mx-auto">
    <p>
<script type="math/tex; mode=display">
\def\sa{a}
\def\sb{b}
\def\sc{c}
\def\sd{d}
\def\se{e}
\def\sf{f}
\def\sg{g}
\def\sh{h}
\def\si{i}
\def\sj{j}
\def\sk{k}
\def\sl{l}
\def\sm{m}
\def\sn{n}
\def\so{o}
\def\sp{p}
\def\sq{q}
\def\sr{r}
\def\ss{s}
\def\st{t}
\def\su{u}
\def\sv{v}
\def\sw{w}
\def\sx{x}
\def\sy{y}
\def\sz{z}
\def\va{\vec{a}}
\def\vb{\vec{b}}
\def\vc{\vec{c}}
\def\vd{\vec{d}}
\def\ve{\vec{e}}
\def\vf{\vec{f}}
\def\vg{\vec{g}}
\def\vh{\vec{h}}
\def\vi{\vec{i}}
\def\vj{\vec{j}}
\def\vk{\vec{k}}
\def\vl{\vec{l}}
\def\vm{\vec{m}}
\def\vn{\vec{n}}
\def\vo{\vec{o}}
\def\vp{\vec{p}}
\def\vq{\vec{q}}
\def\vr{\vec{r}}
\def\vs{\vec{s}}
\def\vt{\vec{t}}
\def\vu{\vec{u}}
\def\vv{\vec{v}}
\def\vw{\vec{w}}
\def\vx{\vec{x}}
\def\vy{\vec{y}}
\def\vz{\vec{z}}
\def\ga{\mathfrak{A}}
\def\gb{\mathfrak{B}}
\def\gc{\mathfrak{C}}
\def\gd{\mathfrak{D}}
\def\ge{\mathfrak{E}}
\def\gf{\mathfrak{F}}
\def\gg{\mathfrak{G}}
\def\gh{\mathfrak{H}}
\def\gi{\mathfrak{I}}
\def\gj{\mathfrak{J}}
\def\gk{\mathfrak{K}}
\def\gl{\mathfrak{L}}
\def\gm{\mathfrak{M}}
\def\gn{\mathfrak{N}}
\def\go{\mathfrak{O}}
\def\gp{\mathfrak{P}}
\def\gq{\mathfrak{Q}}
\def\gr{\mathfrak{R}}
\def\gs{\mathfrak{S}}
\def\gt{\mathfrak{T}}
\def\gu{\mathfrak{U}}
\def\gv{\mathfrak{V}}
\def\gw{\mathfrak{W}}
\def\gx{\mathfrak{X}}
\def\gy{\mathfrak{Y}}
\def\gz{\mathfrak{Z}}
\def\ra{A}
\def\rb{B}
\def\rc{C}
\def\rd{D}
\def\re{E}
\def\rf{F}
\def\rg{G}
\def\rh{H}
\def\ri{I}
\def\rj{J}
\def\rk{K}
\def\rl{L}
\def\rm{M}
\def\rn{N}
\def\ro{O}
\def\rp{P}
\def\rq{Q}
\def\rr{R}
\def\rs{S}
\def\rt{T}
\def\ru{U}
\def\rv{V}
\def\rw{W}
\def\rx{X}
\def\ry{Y}
\def\rz{Z}
\def\rva{\vec{A}}
\def\rvb{\vec{B}}
\def\rvc{\vec{C}}
\def\rvd{\vec{D}}
\def\rve{\vec{E}}
\def\rvf{\vec{F}}
\def\rvg{\vec{G}}
\def\rvh{\vec{H}}
\def\rvi{\vec{I}}
\def\rvj{\vec{J}}
\def\rvk{\vec{K}}
\def\rvl{\vec{L}}
\def\rvm{\vec{M}}
\def\rvn{\vec{N}}
\def\rvo{\vec{O}}
\def\rvp{\vec{P}}
\def\rvq{\vec{Q}}
\def\rvr{\vec{R}}
\def\rvs{\vec{S}}
\def\rvt{\vec{T}}
\def\rvu{\vec{U}}
\def\rvv{\vec{V}}
\def\rvw{\vec{W}}
\def\rvx{\vec{X}}
\def\rvy{\vec{Y}}
\def\rvz{\vec{Z}}
\def\seta{A}
\def\setb{B}
\def\setc{C}
\def\setd{D}
\def\sete{E}
\def\setf{F}
\def\setg{G}
\def\seth{H}
\def\seti{I}
\def\setj{J}
\def\setk{K}
\def\setl{L}
\def\setm{M}
\def\setn{N}
\def\seto{O}
\def\setp{P}
\def\setq{Q}
\def\setr{R}
\def\sets{S}
\def\sett{T}
\def\setu{U}
\def\setv{V}
\def\setw{W}
\def\setx{X}
\def\sety{Y}
\def\setz{Z}
\def\fa{a}
\def\fb{b}
\def\fc{c}
\def\fd{d}
\def\fe{e}
\def\ff{f}
\def\fg{g}
\def\fh{h}
\def\fi{i}
\def\fj{j}
\def\fk{k}
\def\fl{l}
\def\fm{m}
\def\fn{n}
\def\fo{o}
\def\fp{p}
\def\fq{q}
\def\fr{r}
\def\fs{s}
\def\ft{t}
\def\fu{u}
\def\fv{v}
\def\fw{w}
\def\fx{x}
\def\fy{y}
\def\fz{z}
\def\fA{A}
\def\fB{B}
\def\fC{C}
\def\fD{D}
\def\fE{E}
\def\fF{F}
\def\fG{G}
\def\fH{H}
\def\fI{I}
\def\fJ{J}
\def\fK{K}
\def\fL{L}
\def\fM{M}
\def\fN{N}
\def\fO{O}
\def\fP{P}
\def\fQ{Q}
\def\fR{R}
\def\fS{S}
\def\fT{T}
\def\fU{U}
\def\fV{V}
\def\fW{W}
\def\fX{X}
\def\fY{Y}
\def\fZ{Z}
\def\ma{A}
\def\mb{B}
\def\mc{C}
\def\md{D}
\def\me{E}
\def\mf{F}
\def\mg{G}
\def\mh{H}
\def\mi{I}
\def\mj{J}
\def\mk{K}
\def\ml{L}
\def\mm{M}
\def\mn{N}
\def\mo{O}
\def\mp{P}
\def\mq{Q}
\def\mr{R}
\def\ms{S}
\def\mt{T}
\def\matu{U}
\def\mv{V}
\def\mw{W}
\def\mx{X}
\def\my{Y}
\def\mz{Z}
\def\loss{\mathcal{L}}
\newcommand{\dkl}[2]{D_{\text{KL}}\mathopen{}\paren{#1\,||\,#2}}
\newcommand{\dataset}{S}
\newcommand{\ndataset}{N}
\newcommand{\idataset}{n}
\newcommand{\inputRV}{\mathcal{X}}
\newcommand{\inputvec}{\vec{x}}
\newcommand{\ninputvec}[1]{\vec{x}_{#1}}
\newcommand{\iinputvec}[1]{x_{#1}}
\newcommand{\niinputvec}[2]{x_{#1, #2}}
\newcommand{\icpnt}{i}
\newcommand{\inputmatrix}{X}
\newcommand{\inputdim}{D}
\newcommand{\outputval}{y}
\newcommand{\ioutputval}[1]{y_{#1}}
\newcommand{\outputvec}{\vec{y}}
\newcommand{\trainset}{S_{\text{train}}}
\newcommand{\testset}{S_{\text{test}}}
\newcommand{\truemodel}{f_{\text{true}}}
\newcommand{\trainedmodel}{f_{\trainset}}
\newcommand{\linmodel}[1]{f_{#1}}
\newcommand{\bestmodel}{f^{*}}
\newcommand{\model}{f}
\newcommand{\hyperparam}{\lambda}
\newcommand{\linparamv}{\vec{w}}
\newcommand{\ilinparam}[1]{w_{#1}}
\newcommand{\indivloss}{l}
\newcommand{\modelclass}{\mathcal{F}}
\newcommand{\linclass}{\modelclass_{\text{lin}}}
\newcommand{\g}{\mathcal{G}}
\newcommand{\gmse}{\g_{\text{MSE}}}
\newcommand{\glasso}{\g_{\text{lasso}}}
\newcommand{\gridge}{\g_{\text{ridge}}}
\newcommand{\glogit}{\g_{\logit}}
\newcommand{\l}{\mathcal{L}}
\newcommand{\lmse}{\l_{\text{MSE}}}
\newcommand{\lmae}{\l_{\text{MAE}}}
\newcommand{\llasso}{\l_{\text{lasso}}}
\newcommand{\lridge}{\l_{\text{ridge}}}
\newcommand{\llogit}{\l_{\logit}}
\newcommand{\logit}{\sigma}
\newcommand{\reg}{\mathcal{R}}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}
\DeclareMathOperator*{\mean}{mean}
\DeclareMathOperator*{\avg}{avg}
\DeclareMathOperator*{\span}{span}
\DeclareMathOperator*{\var}{var}
\DeclareMathOperator*{\bias}{bias}
\newcommand{\expectation}{\mathbb{E}}
\newcommand{\brak}[1]{\left[#1\right]}
\newcommand{\paren}[1]{\left(#1\right)}
\newcommand{\realset}{\mathbb{R}}
\newcommand{\realvset}[1]{\realset^{#1}}
\newcommand{\prob}{\mathbb{P}}
\newcommand{\gaussian}{\mathcal{N}}
\newcommand{\iid}{\stackrel{\text{i.i.d.}}{\sim}}
\newcommand{\abs}[1]{\left\lvert#1\right\rvert}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand{\normtwo}[1]{\norm{#1}_{2}}
\newcommand{\normone}[1]{\norm{#1}_{1}}
\newcommand{\card}[1]{\left\lvert#1\right\rvert}
\newcommand{\grad}{\nabla}
\newcommand{\dconv}{\stackrel{d}{\to}}
\newcommand{\pconv}{\stackrel{p}{\to}}
\newcommand{\rva}[1]{#1}
\newcommand{\rve}[1]{\vec{#1}}
\newcommand{\obs}[1]{#1}
\newcommand{\vobs}[1]{\vec{#1}}
\newcommand{\distrib}[1]{#1}
\newcommand{\distribof}[2]{#1_{#2}}
\newcommand{\density}[1]{#1}
\newcommand{\densityof}[2]{#1_{#2}}
\newcommand{\distributed}{\sim}
\newcommand{\const}[1]{#1}
\newcommand{\fun}[1]{#1}
</script>
</p>
<div class="typography">

<p>We will use the <code class="highlighter-rouge">whoosh</code> library to store and search our local database.
Install the library with <code class="highlighter-rouge">pip</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install </span>whoosh
</code></pre></div></div>
<p>You can find the documentation here: <a href="https://whoosh.readthedocs.io/en/latest/index.html">Whoosh documentation</a>.</p>
<p>Let’s create a file to encapsulate all our calls to the library.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/backend.py</span>

<span class="n">DB_LOCATION</span> <span class="o">=</span> <span class="s">'providers/local/index'</span>

<span class="kn">from</span> <span class="nn">whoosh.fields</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">DATETIME</span><span class="p">,</span> <span class="n">NUMERIC</span><span class="p">,</span> <span class="n">STORED</span>
<span class="k">def</span> <span class="nf">get_schema</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span>  <span class="n">title</span><span class="o">=</span><span class="n">TEXT</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">field_boost</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
                    <span class="n">authors</span><span class="o">=</span><span class="n">TEXT</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">field_boost</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
                    <span class="n">notes</span><span class="o">=</span><span class="n">TEXT</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                    <span class="n">acquired</span><span class="o">=</span><span class="n">DATETIME</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                    <span class="n">rating</span><span class="o">=</span><span class="n">NUMERIC</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                    <span class="n">cover</span><span class="o">=</span><span class="n">STORED</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">whoosh.index</span> <span class="kn">import</span> <span class="n">create_in</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">location_dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">location_dir</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Index already exist'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">location_dir</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">create_in</span><span class="p">(</span><span class="n">location_dir</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Index created'</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">whoosh.index</span> <span class="kn">import</span> <span class="n">open_dir</span>
<span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="n">location_dir</span> <span class="o">=</span> <span class="n">DB_LOCATION</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">open_dir</span><span class="p">(</span><span class="n">location_dir</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="k">def</span> <span class="nf">add_books</span><span class="p">(</span><span class="n">books</span><span class="p">,</span> <span class="n">database</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">database</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">writer</span><span class="p">()</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'acquired'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="n">acquired</span> <span class="k">if</span> <span class="n">acquired</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
                <span class="n">title</span>    <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                <span class="n">authors</span>  <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'authors'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                <span class="n">notes</span>    <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'notes'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="n">acquired</span><span class="p">,</span>
                <span class="n">rating</span>   <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rating'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">cover</span>    <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cover'</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>


<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">whoosh</span> <span class="kn">import</span> <span class="n">qparser</span>
<span class="kn">from</span> <span class="nn">whoosh.qparser</span> <span class="kn">import</span> <span class="n">MultifieldParser</span>
<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">DB_LOCATION</span><span class="p">)</span>
    <span class="n">og</span> <span class="o">=</span> <span class="n">qparser</span><span class="o">.</span><span class="n">OrGroup</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">MultifieldParser</span><span class="p">([</span><span class="s">"title"</span><span class="p">,</span> <span class="s">"notes"</span><span class="p">,</span> <span class="s">"authors"</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">ix</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">og</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ix</span><span class="o">.</span><span class="n">searcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">searcher</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
                    <span class="s">'title'</span> <span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span>
                    <span class="s">'authors'</span> <span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s">'authors'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">),</span>
                    <span class="s">'rating'</span> <span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rating'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="s">'notes'</span> <span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'notes'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                    <span class="s">'acquired'</span> <span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'acquired'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
                    <span class="s">'cover'</span> <span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cover'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div></div>
<p>We need to create the library folder. Let write a quick script for that:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file providers/local/setup.py</span>
<span class="kn">import</span> <span class="nn">backend</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Creating index at {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">DB_LOCATION</span><span class="p">))</span>
    <span class="n">backend</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(),</span> <span class="n">backend</span><span class="o">.</span><span class="n">DB_LOCATION</span><span class="p">)</span>
</code></pre></div></div>
<p>and run the script from the root of your project:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 providers/local/setup.py
</code></pre></div></div>
<p>We won’t be using this script anymore, but it’s a good idea to keep it around for further reference.</p>
<p>Now that we have a local database, we can actually record the book’s metadata and show what we have in store.</p>
<p>Let’s start with presenting what we have. As previously, there are two things to do: fetch the results and present them using html. Our backend knows how to fetch, so there only remains to create an <code class="highlighter-rouge">html_presenter</code>.</p>
<p>We will use a template as we did for goodreads.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/html_presenter.py</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">template_loader</span> <span class="kn">import</span> <span class="n">load_template</span>

<span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">content</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'&lt;table&gt;'</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">load_template</span><span class="p">(</span><span class="s">'item.html'</span><span class="p">,</span> <span class="s">'./providers/local/'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">content</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cover'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="s">' - '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'authors'</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rating'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'notes'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'acquired'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="p">))</span>
    <span class="n">content</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'&lt;/table&gt;'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</code></pre></div></div>
<p>and the html template in <code class="highlighter-rouge">providers/local/item.html</code>:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- file: providers/local/item.html --&gt;</span>
<span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">"background-color: lightblue;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"$cover"</span> <span class="na">height=</span><span class="s">"200px"</span>
             <span class="na">style=</span><span class="s">"max-width:200px;
                    max-height:200px;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;"</span><span class="nt">&gt;</span> <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;ul&gt;</span>
            <span class="nt">&lt;li&gt;&lt;strong&gt;</span>$title<span class="nt">&lt;/strong&gt;&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>$authors<span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>Rating: $rating | Acquired: $acquired<span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>Notes: $notes<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</code></pre></div></div>
<p>Finally we can complete our <code class="highlighter-rouge">main.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/main.py</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">local</span> <span class="kn">import</span> <span class="n">backend</span>
<span class="kn">from</span> <span class="nn">local</span> <span class="kn">import</span> <span class="n">html_presenter</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'[^a-zA-Z0-9]'</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html_presenter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'name'</span><span class="p">:</span> <span class="s">'Local'</span><span class="p">,</span>
        <span class="s">'html'</span><span class="p">:</span> <span class="n">html</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">handle_get</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">server_helper</span>
<span class="k">def</span> <span class="nf">handle_post</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">!=</span> <span class="s">'/download.html'</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">server_helper</span><span class="o">.</span><span class="n">parse_POST</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="s">'title'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="s">'rating'</span><span class="p">,</span> <span class="n">b</span><span class="s">'-1'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">))</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="s">'authors'</span><span class="p">,</span> <span class="n">b</span><span class="s">''</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span>

        <span class="n">backend</span><span class="o">.</span><span class="n">add_books</span><span class="p">([{</span>
            <span class="s">'title'</span> <span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s">'authors'</span> <span class="p">:</span> <span class="n">authors</span><span class="p">,</span>
            <span class="s">'rating'</span> <span class="p">:</span> <span class="n">rating</span>
        <span class="p">}])</span>

        <span class="n">response</span> <span class="o">=</span> <span class="s">'''
        &lt;html&gt;
            &lt;h1&gt;Success!&lt;/h1&gt;
            &lt;ul&gt;
               &lt;li&gt; Title: {} &lt;/li&gt;
               &lt;li&gt; Authors: {} &lt;/li&gt;
               &lt;li&gt; Rating: {} &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/html&gt;
        '''</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">rating</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">'&lt;pre&gt;'</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">response</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">+=</span> <span class="s">'&lt;/pre&gt;'</span>
        <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>
<p>If you save a few books and try a few searches, you’ll notice that we don’t save any images and that there’s no way to add notes to our records. Let’s add these functionalities now. We will start with the notes.</p>
<p>Instead of directly saving the book’s data into the database, we will add an intermediate endpoint to edit the details and add a custom note. Let’s call this endpoint <code class="highlighter-rouge">/predownload.html</code>.</p>
<p>We will create a file <code class="highlighter-rouge">providers/local/endpoints.py</code> to handle this logic. Move the code inside the <code class="highlighter-rouge">try</code> block of <code class="highlighter-rouge">main.py &gt; handle_post</code> into a function <code class="highlighter-rouge">endpoints.py &gt; download</code> and create a new function <code class="highlighter-rouge">endpoints.py &gt; predownload</code>.</p>
<p><code class="highlighter-rouge">providers/local/main.py</code> becomes:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/main.py (continued)</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">local</span> <span class="kn">import</span> <span class="n">backend</span><span class="p">,</span> <span class="n">html_presenter</span><span class="p">,</span> <span class="n">endpoints</span>

<span class="c"># search(q) and handle_get(s, p) as previously</span>

<span class="k">def</span> <span class="nf">handle_post</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">'/download.html'</span><span class="p">:</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s">'/predownload.html'</span><span class="p">:</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">predownload</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">'&lt;pre&gt;'</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">response</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">+=</span> <span class="s">'&lt;/pre&gt;'</span>
        <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>
<p>and <code class="highlighter-rouge">providers/local/endpoints.py</code> is:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/endpoints.py</span>
<span class="kn">from</span> <span class="nn">local</span> <span class="kn">import</span> <span class="n">backend</span>
<span class="kn">from</span> <span class="nn">local</span> <span class="kn">import</span> <span class="n">html_presenter</span>
<span class="kn">import</span> <span class="nn">server_helper</span>

<span class="k">def</span> <span class="nf">predownload</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>
<p>To implement <code class="highlighter-rouge">predownload</code>, we simply try to extract as much info as we can from the <code class="highlighter-rouge">POST</code> data and write it into an html form.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file:providers/local/endpoints.py (update)</span>
<span class="kn">from</span> <span class="nn">server_helper</span> <span class="kn">import</span> <span class="n">postvar</span>

<span class="k">def</span> <span class="nf">parse_post_variable</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">server_helper</span><span class="o">.</span><span class="n">parse_POST</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'title'</span>   <span class="p">:</span> <span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'title'</span><span class="p">),</span>
        <span class="s">'authors'</span> <span class="p">:</span> <span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'authors'</span><span class="p">),</span>
        <span class="s">'rating'</span>  <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'rating'</span><span class="p">,</span> <span class="s">'-1'</span><span class="p">)),</span>
        <span class="s">'notes'</span>   <span class="p">:</span> <span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'notes'</span><span class="p">),</span>
        <span class="s">'acquired'</span><span class="p">:</span> <span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'acquired'</span><span class="p">),</span>
        <span class="s">'cover'</span>   <span class="p">:</span> <span class="n">postvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">'cover'</span><span class="p">),</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">predownload</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_post_variable</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">html_presenter</span><span class="o">.</span><span class="n">predownload_form</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>
<p>We also need to create the presenter function.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/html_presenter.py (append)</span>

<span class="k">def</span> <span class="nf">predownload_form</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">load_template</span><span class="p">(</span><span class="s">'predownload.html'</span><span class="p">,</span> <span class="s">'./providers/local/'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cover'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'authors'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rating'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'notes'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'acquired'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></div>
<p>And to create the corresponding template.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- file: providers/local/predownload.html --&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;&lt;/head&gt;</span>
<span class="nt">&lt;style&gt;</span>
 <span class="nt">label</span> <span class="p">{</span> <span class="nl">display</span><span class="p">:</span><span class="n">inline-block</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">60px</span><span class="p">;</span> <span class="p">}</span>
 <span class="nt">img</span> <span class="p">{</span> <span class="nl">max-width</span><span class="p">:</span><span class="m">200px</span><span class="p">;</span> <span class="nl">max-height</span><span class="p">:</span><span class="m">200px</span><span class="p">;</span>
     <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span> <span class="nl">margin-left</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span> <span class="nl">margin-right</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span> <span class="p">}</span>
 <span class="nc">.img</span> <span class="p">{</span> <span class="nl">background-color</span><span class="p">:</span> <span class="no">lightblue</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;table&gt;&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"img"</span><span class="nt">&gt;</span> <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"$cover"</span> <span class="na">height=</span><span class="s">"200px"</span><span class="nt">&gt;</span> <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"download.html"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">value=</span><span class="s">"$title"</span> <span class="na">size=</span><span class="s">"100"</span> <span class="na">placeholder=</span><span class="s">"Title"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;label&gt;</span>Authors<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"authors"</span> <span class="na">value=</span><span class="s">"$authors"</span> <span class="na">size=</span><span class="s">"100"</span> <span class="na">placeholder=</span><span class="s">"Authors"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;label&gt;</span>Notes<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"notes"</span> <span class="na">rows=</span><span class="s">"4"</span> <span class="na">cols=</span><span class="s">"100"</span><span class="nt">&gt;</span>$notes<span class="nt">&lt;/textarea&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;label&gt;</span>Rating<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"rating"</span>   <span class="na">value=</span><span class="s">"$rating"</span> <span class="na">placeholder=</span><span class="s">"Rating"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;label&gt;</span>Acquired<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"acquired"</span> <span class="na">value=</span><span class="s">"$acquired"</span> <span class="na">placeholder=</span><span class="s">"Acquired Date"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;label&gt;</span>Cover<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"cover"</span> <span class="na">value=</span><span class="s">"$cover"</span> <span class="na">placeholder=</span><span class="s">"Cover URL"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Download"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;</span>
</code></pre></div></div>
<p>Before we test this endpoint, we need to update the goodread’s download form. I copied the whole file below and indicated the line that changed with <code class="highlighter-rouge">&lt;!--new--&gt;</code>: the <code class="highlighter-rouge">action</code> field is modified from <code class="highlighter-rouge">download.html</code> to <code class="highlighter-rouge">predownload.html</code> and I added a hidden input for <code class="highlighter-rouge">cover</code>.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- file: providers/goodreads/item.html --&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td</span> <span class="na">style=</span><span class="s">"background-color: lightblue;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"$img"</span> <span class="na">height=</span><span class="s">"200px"</span>
             <span class="na">style=</span><span class="s">"max-width:200px;
                    max-height:200px;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;"</span><span class="nt">&gt;</span> <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;ul&gt;</span>
             <span class="nt">&lt;li&gt;&lt;strong&gt;</span>$title<span class="nt">&lt;/strong&gt;&lt;/li&gt;</span>
             <span class="nt">&lt;li&gt;</span>$authors<span class="nt">&lt;/li&gt;</span>
             <span class="nt">&lt;li&gt;</span>Rating: $rating<span class="nt">&lt;/li&gt;</span>
<span class="c">&lt;!--new--&gt;</span>   <span class="nt">&lt;li&gt;&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"predownload.html"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"title"</span>   <span class="na">value=</span><span class="s">"$title"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"authors"</span> <span class="na">value=</span><span class="s">"$authors"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"rating"</span>  <span class="na">value=</span><span class="s">"$rating"</span><span class="nt">&gt;</span>
<span class="c">&lt;!--new--&gt;</span>          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"cover"</span> <span class="na">value=</span><span class="s">"$img"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Download"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;/form&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;</span>
</code></pre></div></div>
<p>There remains to implement the <code class="highlighter-rouge">download</code> endpoint. Simply parse the data from the <code class="highlighter-rouge">POST</code> variable and use the <code class="highlighter-rouge">add_book</code> function.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/endpoints.py (append)</span>

<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_post_variable</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="n">backend</span><span class="o">.</span><span class="n">add_books</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">html_presenter</span><span class="o">.</span><span class="n">downloaded</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#file: providers/local/html_presenter.py (append)</span>

<span class="k">def</span> <span class="nf">downloaded</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">load_template</span><span class="p">(</span><span class="s">'downloaded.html'</span><span class="p">,</span> <span class="s">'./providers/local/'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cover'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'authors'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rating'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'notes'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'acquired'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></div>
<p>and create the corresponding html template.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- file: providers/local/downloaded.html --&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;&lt;/head&gt;</span>
<span class="nt">&lt;style&gt;</span>
 <span class="nt">img</span> <span class="p">{</span> <span class="nl">max-width</span><span class="p">:</span><span class="m">200px</span><span class="p">;</span> <span class="nl">max-height</span><span class="p">:</span><span class="m">200px</span><span class="p">;</span>
     <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span> <span class="nl">float</span><span class="p">:</span><span class="nb">left</span><span class="p">;</span> <span class="p">}</span>
 <span class="nt">tr</span> <span class="o">&gt;</span> <span class="nd">:first-child</span> <span class="p">{</span> <span class="nl">width</span><span class="p">:</span><span class="m">100px</span><span class="p">;</span> <span class="nl">text-align</span><span class="p">:</span><span class="nb">right</span><span class="p">;</span> <span class="nl">border-right</span><span class="p">:</span><span class="m">1px</span> <span class="nb">solid</span> <span class="no">black</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;div&gt;</span>
<span class="nt">&lt;h1&gt;</span> Downloaded <span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.html"</span><span class="nt">&gt;</span> <span class="ni">&amp;larr;</span> back <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"$cover"</span> <span class="na">height=</span><span class="s">"200px"</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span> Title    <span class="nt">&lt;/td&gt;&lt;td&gt;</span> $title    <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span> Authors  <span class="nt">&lt;/td&gt;&lt;td&gt;</span> $authors  <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span> Notes    <span class="nt">&lt;/td&gt;&lt;td&gt;</span> $notes    <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span> Rating   <span class="nt">&lt;/td&gt;&lt;td&gt;</span> $rating   <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span> Acquired <span class="nt">&lt;/td&gt;&lt;td&gt;</span> $acquired <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p><a href="ebook-library-4.html">previous article</a></p>
</div>
    </article>
    </div><!-- row -->
    
    <div class="row mt-1">
      <article class="col-lg-8 mx-auto recommendations">
        <p class='title'>Other articles you might like:</p>
        <ul>
          
            <li class="en"><img class="flag-icon" src="//julienharbulot.com/images/languages/en.png"> <a href="//julienharbulot.com/win-extend-screen.html">Keyboard shortcut and command line utility to switch display (Windows)</a></li>
          
            <li class="en"><img class="flag-icon" src="//julienharbulot.com/images/languages/en.png"> <a href="//julienharbulot.com/wsl-dev-environment-2020.html">Using WSL-2 as a dev environment</a></li>
          
            <li class="en"><img class="flag-icon" src="//julienharbulot.com/images/languages/en.png"> <a href="//julienharbulot.com/bias-variance-decomposition.html">The bias-variance decomposition</a></li>
          
        </ul>
      </article>
    </div>
    
    
    <div class="row mb=5 mt-5">
      <article class="col-lg-8 mx-auto">
        <div id="hyvor-talk-view"></div>
        <script type="text/javascript">
            var HYVOR_TALK_WEBSITE = '625';
            var HYVOR_TALK_CONFIG = {
                url: 'ebook-library-5.html',
                id: 'ebook-library-5.html'
            };
        </script>
      </article>
    </div><!-- row -->
    
    <footer class="row">
        <div class="col-lg-8 mx-auto text-center">
          <p><small>
          
            Last updated: 01/14/21 <br/>
          
          
          Copyright &copy; 2021 Julien Harbulot
          </small></p>
        </div>
    </footer>
    </div>

  <script>
  // bootstrap table
  tables = document.getElementsByTagName('table');
  for (i = 0; i < tables.length; i++) {
    tables[i].classList.add('table');
    tables[i].classList.add('table-bordered');
  }

  // Paragraphs that contain only images are marked with custom class for styling
  ps = document.getElementsByTagName('p');
  Array.from(ps).forEach(function(p){
    if (p.getElementsByTagName('img').length > 0 && p.textContent.trim().length == 0) {
        p.classList.add('img-container');
    }
  });
  </script>


    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script>
        prev_onload_a = window.onload;
        window.onload = function() {
            if (prev_onload_a) {
                prev_onload_a();
            }
            var navlinks = document.getElementsByClassName("nav-link");
            var i;
            for (i = 0; i < navlinks.length; i++) {
                const target = new URL(navlinks[i].href)
                if (location.pathname == target.pathname) {
                    navlinks[i].classList.add('active')
                }
            }
        }
    </script>    

    

<script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script>


    </body>
</html>